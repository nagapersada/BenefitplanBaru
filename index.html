<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DVTEAM NP - Benefit Plan</title>
    
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/BenefitPlan/manifest.json">
    <link rel="apple-touch-icon" href="/BenefitPlan/images/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
         body { font-family: 'Inter', sans-serif; background-color: #020617; background-image: radial-gradient(ellipse at top, #1e293b, #020617); color: #cbd5e1; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Splash Screen */
        #splash-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 1.5rem; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; background-color: #020617; transition: opacity 0.5s ease-out; }
        .splash-logo { max-width: 280px; width: 80%; height: auto; margin-bottom: 1.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.1)); }
        .splash-title { font-size: 1.75rem; font-weight: 800; color: #f0f9ff; margin-bottom: 0.5rem; }
        
        .enter-button { margin-top: 2rem; background: linear-gradient(to right, #eab308, #f59e0b); color: #1e293b; padding: 0.75rem 2.5rem; font-weight: 700; border-radius: 9999px; box-shadow: 0 4px 15px -3px rgba(234, 179, 8, 0.5); transition: transform 0.2s; cursor: pointer; border: none; }
        .enter-button:active { transform: scale(0.95); }
        
        /* Dashboard */
        #dashboard-content { display: none; min-height: 100vh; opacity: 0; transition: opacity 0.5s ease-in; padding-bottom: 2rem; }
        
        /* Animations */
        @keyframes pulse-update { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        
        .juara-text { background: linear-gradient(to right, #facc15, #fbbf24, #eab308); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background-color: rgba(30, 41, 59, 0.65); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); }
        .number-pulse { animation: pulse-update 0.3s ease-out; color: #a7f3d0 !important; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; display: none; }
        
        /* Action Buttons */
        .action-btn-icon-only { 
            display: flex; align-items: center; justify-content: center; 
            background-color: rgba(30, 41, 59, 0.6); color: #94a3b8; 
            border: 1px solid rgba(148, 163, 184, 0.2); 
            width: 100%; aspect-ratio: 1 / 1; max-width: 60px; 
            border-radius: 12px; transition: all 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .action-btn-icon-only:active:not(:disabled) { transform: scale(0.92); background-color: rgba(51, 65, 85, 0.9); }
        .action-btn-icon-only:disabled { background-color: rgba(15, 23, 42, 0.4); color: #334155; border-color: rgba(255,255,255,0.05); cursor: not-allowed; }
        .action-btn-icon-only.clicked { background: linear-gradient(135deg, #059669, #047857); color: #ffffff; border-color: transparent; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); transform: scale(0.95); }
        
        .action-item { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .action-label { margin-top: 0.4rem; font-size: 0.65rem; font-weight: 600; color: #94a3b8; text-align: center; text-transform: uppercase; }
        
        /* Member Box Styles */
        .member-box-done { background-color: #4f46e5; color: white; border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); } /* Ungu (Selesai) */
        .member-box-active { background-color: rgba(30, 41, 59, 0.8); color: #fbbf24; border-color: #f59e0b; animation: pulse-border 2s infinite; } /* Kuning (Sedang Dikerjakan) */
        .member-box-pending { background-color: rgba(15, 23, 42, 0.5); border-color: #334155; color: #475569; } /* Abu (Belum) */
        
        .duplication-badge { font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: rgba(51, 65, 85, 0.8); color: #cbd5e1; margin-top: 2px; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="/BenefitPlan/images/logo-splash.png" alt="DVTEAM NP Logo" class="splash-logo" onerror="this.style.display='none';">
        <h1 class="splash-title">DVTEAM NP</h1>
        <p class="splash-subtitle text-sm text-slate-400">Simulator Benefit Plan</p>
        <button id="enter-button" class="enter-button">MULAI</button>
    </div>

    <div id="dashboard-content">
        <canvas id="confetti-canvas"></canvas>
        
        <div class="container mx-auto px-4 py-6 max-w-lg relative z-10">
            <header class="flex justify-between items-center mb-6">
                <div><h1 class="text-xl font-bold text-white tracking-tight">Dashboard Proyeksi</h1><p class="text-xs text-slate-400 mt-1">Maksimalkan potensi tim Anda</p></div>
                <button id="play-audio-button" class="p-3 bg-slate-800/80 rounded-full border border-slate-700 active:scale-95 transition-transform">
                    <svg id="speaker-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-cyan-400"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a3 3 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>
                    <svg id="speaker-off-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-slate-500 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>
                </button>
            </header>
    
            <div class="space-y-4">
                <div class="card p-4 space-y-2 bg-slate-800/50">
                    <div class="flex justify-between items-center text-xs"><span class="text-slate-400">Bonus Reveral Lv.1</span><span class="font-bold text-emerald-400" id="resBonusReveral1">@300 USDT</span></div>
                    <div class="flex justify-between items-center text-xs"><span class="text-slate-400">Bonus Reveral Lv.2</span><span class="font-bold text-emerald-400" id="resBonusReveral2">@300 USDT</span></div>
                    <div class="flex justify-between items-center text-xs pt-1 border-t border-slate-700"><span class="text-slate-300">Bonus Tim</span><span class="font-bold text-emerald-400" id="resBonusTim">20 USDT</span></div>
                </div>

                <div class="card p-5 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-6">
                        <div class="space-y-3">
                            <div class="flex flex-col">
                                <div class="flex items-center gap-2"><span id="anda-label" class="bg-blue-500/20 text-blue-300 text-[10px] font-bold px-2 py-1 rounded border border-blue-500/30">ANDA</span><span id="crown-icon" class="hidden text-base">ðŸ‘‘</span></div>
                                <div id="ketua-tim-label" class="h-4 mt-1"></div>
                            </div>
                            <div>
                                <div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Peringkat</div>
                                <div class="flex items-center gap-2"><div id="kpiStatus" class="text-sm"></div><div id="kpiBonusPeringkat" class="text-sm font-bold text-emerald-400"></div></div>
                            </div>
                        </div>
                        <div class="text-right space-y-3">
                            <div><div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Total Bonus</div><div id="kpiTotalBonus" class="text-xl font-black text-cyan-400 leading-none">0</div></div>
                            <div><div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Saldo Akun</div><div id="resModalAwalPanel" class="text-sm font-bold text-white">500</div></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4 p-3 bg-slate-900/30 rounded-lg border border-slate-700/30">
                        <div><div class="text-[10px] text-slate-500 uppercase">Batasan Modal</div><div id="resBatasanModal" class="text-sm font-bold text-white">500 USDT</div></div>
                        <div class="text-right"><div class="text-[10px] text-slate-500 uppercase">Total Anggota</div><div id="resTotalAnggotaPanel" class="text-sm font-bold text-white">0</div></div>
                    </div>

                    <div class="space-y-1 mb-5" id="sinyalContainer"></div>

                    <div id="action-button-container" class="border-t border-slate-700/50 pt-5">
                        
                        <div id="phase-1-buttons" class="grid grid-cols-4 gap-3"> 
                            <div class="action-item"> <button id="btn-tanya" onclick="handlePhase1Click('tanya')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg></button> <span class="action-label">Tanya</span> </div>
                            <div class="action-item"> <button id="btn-cerita" onclick="handlePhase1Click('cerita')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg></button> <span class="action-label">Cerita</span> </div>
                            <div class="action-item"> <button id="btn-undang" onclick="handlePhase1Click('undang')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg></button> <span class="action-label">Undang</span> </div>
                            <div class="action-item"> <button id="btn-jelaskan" onclick="handlePhase1Click('jelaskan')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 21h16.5M12 3v16.5m0 0L7.5 12m4.5 7.5L16.5 12" /></svg></button> <span class="action-label">Jelaskan</span> </div>
                        </div>

                        <div id="phase-2-buttons" class="hidden grid grid-cols-4 gap-3">
                            <div class="action-item"> <button id="btn-sapa" onclick="handlePhase2Click('sapa')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 0 1 3.15 0V15M6.9 7.575V12a6.75 6.75 0 0 0 6.75 6.75H18a2.25 2.25 0 0 0 2.25-2.25V9m-12.862 3v-1.575c0-.698.426-1.339 1.072-1.616L12 4.575" /></svg></button> <span class="action-label">Sapa</span> </div>
                            <div class="action-item"> <button id="btn-sharing" onclick="handlePhase2Click('sharing')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" /></svg></button> <span class="action-label">Sharing</span> </div>
                            <div class="action-item"> <button id="btn-solusi" onclick="handlePhase2Click('solusi')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-1.5m0 0a6.01 6.01 0 0 1-6-6v-1.5m6 7.5a6.01 6.01 0 0 0 6-6v-1.5m-6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z" /></svg></button> <span class="action-label">Solusi</span> </div>
                            <div class="action-item"> <button id="btn-duplikasi" onclick="handlePhase2Click('duplikasi')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 0 0-2.25-2.25H6A2.25 2.25 0 0 0 3.75 6v8.25A2.25 2.25 0 0 0 6 16.5h2.25m8.25-8.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-7.5A2.25 2.25 0 0 1 8.25 18v-1.5m8.25-8.25h-6a2.25 2.25 0 0 0-2.25 2.25v6" /></svg></button> <span class="action-label">Duplikasi</span> </div>
                        </div>

                        <div id="phase-3-buttons" class="hidden grid grid-cols-4 gap-3">
                            <div class="col-start-2 action-item"> <button id="btn-edifikasi" onclick="handlePhase3Click('edifikasi')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg></button> <span class="action-label">Edifikasi</span> </div>
                            <div class="action-item"> <button id="btn-duplikasi-level" onclick="handlePhase3Click('duplikasi')" class="action-btn-icon-only"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" /></svg></button> <span class="action-label">Duplikasi</span> </div>
                        </div>
                    </div>

                    <div class="mt-6 space-y-4" id="controls-body"></div>

                    <div id="fokus-message" class="mt-6 text-center"><p class="text-xs font-bold uppercase text-amber-400 tracking-wider bg-amber-900/30 py-1 rounded inline-block px-3">Fokus: Rekrut 5 Anggota</p></div>
                    <div id="juara-message-container" class="mt-6 text-center hidden"><h3 class="juara-text text-2xl font-extrabold tracking-wider">SELAMAT ANDA JUARA!</h3></div>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="tutorial-audio" src="benefit(2).mp3" preload="auto"></audio>
    <audio id="champions-audio" src="Champions (2).mp3" preload="auto"></audio>

    <script>
        // --- DATA & STATE ---
        let anggotaLevels = [0, 0, 0, 0, 0]; 
        let simulationMode = 'recruit_lv1'; 
        let memberState = {};
        let phase1ButtonsClicked = { tanya: false, cerita: false, undang: false, jelaskan: false }; 
        let phase2ButtonsClicked = { sapa: false, sharing: false, solusi: false, duplikasi: false };
        let phase3ButtonsClicked = { edifikasi: false, duplikasi: false };
        
        let currentMemberIndex = 0; 
        let currentBinaIndex = 0;   
        let currentDuplicationState = { level: 2, memberIndex: 0 }; 
        const members = ['A', 'B', 'C', 'D', 'E'];
        let currentPhase = 1; 
        let confettiInterval; let animationFrameId;

        function resetMemberState() { 
            memberState = { 
                A: { isLeader: false, duplicationLevels: 0 }, 
                B: { isLeader: false, duplicationLevels: 0 }, 
                C: { isLeader: false, duplicationLevels: 0 }, 
                D: { isLeader: false, duplicationLevels: 0 }, 
                E: { isLeader: false, duplicationLevels: 0 } 
            }; 
        }

        // --- PHASE 1 LOGIC (FIXED) ---
        function handlePhase1Click(buttonName) { 
            if (currentPhase !== 1) return; 
            
            // 1. Activate Clicked Button
            phase1ButtonsClicked[buttonName] = true; 
            const btn = document.getElementById(`btn-${buttonName}`); 
            if (btn) { btn.disabled = true; btn.classList.add('clicked'); } 

            // 2. Check Completion
            const allClicked = Object.values(phase1ButtonsClicked).every(val => val === true); 
            if (allClicked) { 
                if (currentMemberIndex < members.length) { 
                    const memberLetter = members[currentMemberIndex]; 
                    currentMemberIndex++; // Move to next
                    handleCheckboxChange(); // Update Visual
                    
                    if (currentMemberIndex < members.length) { 
                        // FORCE RESET FOR NEXT MEMBER (Fixes the bug)
                        setTimeout(resetPhase1Buttons, 300); 
                    } else { 
                        // End of Phase 1
                        setTimeout(() => {
                            currentPhase = 2; 
                            document.getElementById('phase-1-buttons').classList.add('hidden'); 
                            document.getElementById('phase-2-buttons').classList.remove('hidden'); 
                            document.getElementById('controls-label').textContent = "Membangun Ketua Tim";
                            updateFokusMessage();
                        }, 500);
                    } 
                } 
            } 
        }

        function resetPhase1Buttons() { 
            // Reset Logical State
            phase1ButtonsClicked = { tanya: false, cerita: false, undang: false, jelaskan: false }; 
            // Reset Visual State
            ['tanya', 'cerita', 'undang', 'jelaskan'].forEach(name => { 
                const btn = document.getElementById(`btn-${name}`); 
                if (btn) { 
                    btn.disabled = false; 
                    btn.classList.remove('clicked'); 
                } 
            }); 
        }

        // --- PHASE 2 LOGIC (FIXED) ---
        function handlePhase2Click(buttonName) { 
            if (currentPhase !== 2) return; 
            
            phase2ButtonsClicked[buttonName] = true; 
            const btn = document.getElementById(`btn-${buttonName}`); 
            if (btn) { btn.disabled = true; btn.classList.add('clicked'); } 

            const allClicked = Object.values(phase2ButtonsClicked).every(val => val === true); 
            if (allClicked) { 
                if (currentBinaIndex < members.length) { 
                    const memberLetter = members[currentBinaIndex]; 
                    if (currentBinaIndex === 0) { 
                        simulationMode = 'duplicating_lv1'; 
                        renderControls(); 
                    } 
                    memberState[memberLetter].isLeader = true; 
                    memberState[memberLetter].duplicationLevels = 1; 
                    updateSimulation(); 
                    currentBinaIndex++; 
                    
                    if (currentBinaIndex < members.length) { 
                        setTimeout(resetPhase2Buttons, 300); 
                    } else { 
                        setTimeout(() => {
                            currentPhase = 3; 
                            document.getElementById('phase-2-buttons').classList.add('hidden'); 
                            document.getElementById('phase-3-buttons').classList.remove('hidden'); 
                            updateFokusMessage();
                        }, 500);
                    } 
                } 
            } 
        }

        function resetPhase2Buttons() { 
            phase2ButtonsClicked = { sapa: false, sharing: false, solusi: false, duplikasi: false }; 
            ['sapa', 'sharing', 'solusi', 'duplikasi'].forEach(name => { 
                const btn = document.getElementById(`btn-${name}`); 
                if (btn) { btn.disabled = false; btn.classList.remove('clicked'); } 
            }); 
        }

        // --- PHASE 3 LOGIC (FIXED) ---
        function handlePhase3Click(buttonName) { 
            if (currentPhase !== 3) return; 
            
            phase3ButtonsClicked[buttonName] = true; 
            const btnId = (buttonName === 'duplikasi') ? 'btn-duplikasi-level' : 'btn-edifikasi'; 
            const btn = document.getElementById(btnId); 
            if (btn) { btn.disabled = true; btn.classList.add('clicked'); } 

            const allClicked = Object.values(phase3ButtonsClicked).every(val => val === true); 
            if (allClicked) { 
                const { level, memberIndex } = currentDuplicationState; 
                if (level > 4) return; 
                
                const memberLetter = members[memberIndex]; 
                memberState[memberLetter].duplicationLevels = level; 
                updateSimulation(); 
                
                let newMemberIndex = memberIndex + 1; 
                let newLevel = level; 
                if (newMemberIndex >= members.length) { 
                    newMemberIndex = 0; 
                    newLevel = level + 1; 
                } 
                currentDuplicationState = { level: newLevel, memberIndex: newMemberIndex }; 
                
                if (newLevel <= 4) { 
                    setTimeout(resetPhase3Buttons, 300); 
                } 
            } 
        }

        function resetPhase3Buttons() { 
            phase3ButtonsClicked = { edifikasi: false, duplikasi: false }; 
            const btnEd = document.getElementById('btn-edifikasi'); 
            if(btnEd) { btnEd.disabled = false; btnEd.classList.remove('clicked'); } 
            const btnDup = document.getElementById('btn-duplikasi-level'); 
            if(btnDup) { btnDup.disabled = false; btnDup.classList.remove('clicked'); } 
        }

        // --- NAVIGATION ---
        function goBackOneStep() { 
            stopConfetti(); 
            const championsAudio = document.getElementById('champions-audio'); 
            if (championsAudio) championsAudio.pause(); 
            
            if (currentPhase === 3) { 
                let { level, memberIndex } = currentDuplicationState; 
                let prevMemberIndex = memberIndex - 1; 
                let prevLevel = level; 
                if (prevMemberIndex < 0) { prevMemberIndex = 4; prevLevel = level - 1; } 
                
                if (prevLevel < 2) { 
                    currentPhase = 2; currentBinaIndex = 5; 
                    document.getElementById('phase-3-buttons').classList.add('hidden'); 
                    document.getElementById('phase-2-buttons').classList.remove('hidden'); 
                    resetPhase2Buttons(); 
                } else { 
                    const memberToRevert = members[prevMemberIndex]; 
                    memberState[memberToRevert].duplicationLevels = prevLevel - 1; 
                    currentDuplicationState = { level: prevLevel, memberIndex: prevMemberIndex }; 
                    resetPhase3Buttons(); 
                    updateSimulation(); 
                } 
            } else if (currentPhase === 2) { 
                if (currentBinaIndex === 0) { 
                    currentPhase = 1; currentMemberIndex = 5; simulationMode = 'recruit_lv1'; 
                    document.getElementById('phase-2-buttons').classList.add('hidden'); 
                    document.getElementById('phase-1-buttons').classList.remove('hidden'); 
                    resetPhase1Buttons(); renderControls(); 
                } else { 
                    currentBinaIndex--; 
                    const memberToRevert = members[currentBinaIndex]; 
                    memberState[memberToRevert].isLeader = false; 
                    memberState[memberToRevert].duplicationLevels = 0; 
                    resetPhase2Buttons(); updateSimulation(); 
                } 
            } else if (currentPhase === 1) { 
                if (currentMemberIndex > 0) { 
                    currentMemberIndex--; resetPhase1Buttons(); handleCheckboxChange(); 
                } 
            } 
            updateFokusMessage();
        }

        function initializeSimulator() { 
            stopConfetti(); 
            const championsAudio = document.getElementById('champions-audio'); 
            if (championsAudio) championsAudio.pause(); 
            
            resetMemberState(); 
            simulationMode = 'recruit_lv1'; 
            currentMemberIndex = 0; 
            currentBinaIndex = 0; 
            currentDuplicationState = { level: 2, memberIndex: 0 }; 
            currentPhase = 1; 
            
            document.getElementById('phase-1-buttons').classList.remove('hidden'); 
            document.getElementById('phase-2-buttons').classList.add('hidden'); 
            document.getElementById('phase-3-buttons').classList.add('hidden'); 
            
            resetPhase1Buttons(); 
            resetPhase2Buttons(); 
            resetPhase3Buttons(); 
            renderControls(); 
            
            handleCheckboxChange(); 
            document.getElementById('controls-label').textContent = "Membangun Anggota Tim"; 
            updateFokusMessage();
        }

        // --- RENDER UI (VISUAL FEEDBACK) ---
        function handleCheckboxChange() { 
            if (simulationMode === 'recruit_lv1') { anggotaLevels[0] = currentMemberIndex; } 
            renderControls(); 
            updateSimulation(); 
        }

        function renderControls() { 
            const container = document.getElementById('controls-body'); 
            if(!container) return; 
            
            let labelText = "Membangun Anggota Tim"; 
            if (currentPhase > 1) labelText = "Membangun Ketua Tim";
            
            // GENERATE BOXES WITH STATUS COLORS
            let checkboxHTML = members.map((letter, index) => {
                let boxClass = "member-box-pending"; // Default Gray
                
                if (currentPhase === 1) {
                    if (index < currentMemberIndex) boxClass = "member-box-done"; // Done (Purple)
                    else if (index === currentMemberIndex) boxClass = "member-box-active"; // Active (Yellow Pulse)
                } else {
                    if (memberState[letter].isLeader) boxClass = "member-box-done bg-amber-500 border-amber-400"; // Leader (Amber)
                    else if (index === currentBinaIndex && currentPhase === 2) boxClass = "member-box-active";
                }

                return `
                <div> 
                    <div id="kt-label-${letter}" class="text-center h-4 mb-1 text-[10px] font-bold text-amber-400 drop-shadow">${memberState[letter].isLeader ? 'ðŸ‘‘' : ''}</div> 
                    <div class="w-full aspect-square rounded-lg border flex items-center justify-center font-bold text-sm transition-all duration-300 ${boxClass}">
                        ${letter}
                    </div> 
                    <div class="mt-1 flex flex-col items-center space-y-1" id="duplication-tree-${letter}"></div> 
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="flex justify-between items-center mb-2"> 
                    <label id="controls-label" class="block font-bold text-slate-400 text-xs uppercase tracking-wider">${labelText}</label> 
                    <button id="back-button" class="text-slate-400 hover:text-amber-400 p-1.5 rounded-full bg-slate-800/50 border border-slate-700" onclick="goBackOneStep()"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /> </svg> 
                    </button> 
                </div> 
                <div class="grid grid-cols-5 gap-2"> ${checkboxHTML} </div>
            `; 
            
            renderDuplicationTree();
        }

        function renderDuplicationTree() { 
            Object.entries(memberState).forEach(([letter, member]) => { 
                const treeContainer = document.getElementById(`duplication-tree-${letter}`); 
                if (treeContainer) { 
                    treeContainer.innerHTML = ''; 
                    if (member.isLeader) { 
                        for (let i = 1; i <= member.duplicationLevels; i++) { 
                            const numberValue = 5 ** i; 
                            const numberDiv = document.createElement('div'); 
                            numberDiv.className = "duplication-badge"; 
                            numberDiv.textContent = numberValue.toLocaleString('id-ID'); 
                            treeContainer.appendChild(numberDiv); 
                        } 
                    } 
                } 
            }); 
        }

        function updateFokusMessage() {
            const msgEl = document.querySelector('#fokus-message p');
            if(msgEl) {
                if(currentPhase === 1) msgEl.textContent = "Fokus: Rekrut 5 Anggota";
                else if(currentPhase === 2) msgEl.textContent = "Fokus: Bina 5 Ketua Tim";
                else msgEl.textContent = "Fokus: Duplikasi Kedalaman";
            }
        }

        // --- CALCULATION (Recursive) ---
        function getMemberContribution(level) {
            if (level === 0) return 30; 
            return 500 + (5 * getMemberContribution(level - 1));
        }

        function updateSimulation() { 
            if (simulationMode === 'duplicating_lv1') { 
                anggotaLevels[0] = 5; anggotaLevels.fill(0, 1); 
                Object.values(memberState).forEach(member => { 
                    if (member.isLeader) { 
                        if (member.duplicationLevels >= 1) anggotaLevels[1] += 5; 
                        if (member.duplicationLevels >= 2) anggotaLevels[2] += 25; 
                        if (member.duplicationLevels >= 3) anggotaLevels[3] += 125; 
                        if (member.duplicationLevels >= 4) anggotaLevels[4] += 625; 
                    } 
                }); 
            } else { 
                anggotaLevels[0] = currentMemberIndex; 
                anggotaLevels.fill(0, 1); 
            } 
            
            const totalAnggotaTim = anggotaLevels.reduce((a, b) => a + b, 0); 
            const totalAnggota = totalAnggotaTim + 1; 
            const depositAwal = 100; 

            const bonusTim = anggotaLevels[0] >= 5 ? 20 : 0; 
            let cumulativeBonusPeringkat = 0; 
            if (anggotaLevels[0] >= 5) cumulativeBonusPeringkat += 50; 
            if (totalAnggota >= 31) cumulativeBonusPeringkat += 100; 
            if (totalAnggota >= 101) cumulativeBonusPeringkat += 200; 
            if (totalAnggota >= 201) cumulativeBonusPeringkat += 400; 
            if (totalAnggota >= 351) cumulativeBonusPeringkat += 600; 
            if (totalAnggota >= 501) cumulativeBonusPeringkat += 1000; 
            if (totalAnggota >= 901) cumulativeBonusPeringkat += 2000; 
            if (totalAnggota >= 1601) cumulativeBonusPeringkat += 3000; 
            if (totalAnggota >= 3501) cumulativeBonusPeringkat += 5000;
            
            const totalBonus = bonusTim + cumulativeBonusPeringkat; 
            const saldoAkun = depositAwal + totalBonus; 

            let batasanModal = 500; 
            if (simulationMode === 'recruit_lv1') {
                batasanModal += anggotaLevels[0] * 30;
            } else {
                Object.values(memberState).forEach(member => {
                    if (member.isLeader) batasanModal += getMemberContribution(member.duplicationLevels);
                    else batasanModal += 30; 
                });
            }

            let status = "Anggota", statusColor = "text-yellow-400";
            if (totalAnggota >= 3501) { status = "VIP 9"; statusColor = "text-violet-400"; }
            else if (totalAnggota >= 1601) { status = "VIP 8"; statusColor = "text-violet-300"; }
            else if (totalAnggota >= 901) { status = "VIP 7"; statusColor = "text-indigo-400"; }
            else if (totalAnggota >= 501) { status = "VIP 6"; statusColor = "text-indigo-300"; }
            else if (totalAnggota >= 351) { status = "VIP 5"; statusColor = "text-blue-400"; }
            else if (totalAnggota >= 201) { status = "VIP 4"; statusColor = "text-blue-300"; }
            else if (totalAnggota >= 101) { status = "VIP 3"; statusColor = "text-cyan-400"; }
            else if (totalAnggota >= 31) { status = "VIP 2"; statusColor = "text-cyan-300"; }
            else if (anggotaLevels[0] >= 5) { status = "VIP 1"; statusColor = "text-emerald-400"; }

            let bonusVolume = "0%";
            if (anggotaLevels[0] >= 5) {
                if (totalAnggota >= 3501) bonusVolume = "5%";
                else if (totalAnggota >= 1601) bonusVolume = "3.5%";
                else if (totalAnggota >= 901) bonusVolume = "3%";
                else if (totalAnggota >= 501) bonusVolume = "2.5%";
                else if (totalAnggota >= 351) bonusVolume = "2%";
                else if (totalAnggota >= 201) bonusVolume = "1.5%";
                else if (totalAnggota >= 101) bonusVolume = "1%";
                else if (totalAnggota >= 31) bonusVolume = "0.5%";
                else if (totalAnggota >= 5) bonusVolume = "0.3%";
            }

            let sinyalKe3 = "Tidak Aktif"; 
            const isALeader = memberState.A.isLeader;
            const isBLeader = memberState.B.isLeader;
            const isCLeader = memberState.C.isLeader;
            const isDLeader = memberState.D.isLeader;
            const isELeader = memberState.E.isLeader;
            const andaIsVip1 = (anggotaLevels[0] >= 5);

            if (andaIsVip1) {
                if (isALeader && isBLeader && isCLeader && isDLeader && isELeader) sinyalKe3 = "Permanen";
                else if (isBLeader && isDLeader) sinyalKe3 = "Tidak Aktif"; 
                else if (isALeader && isBLeader && isCLeader) sinyalKe3 = "20 Hari";
                else if ((!isALeader && !isBLeader && !isCLeader && !isDLeader && !isELeader) || (isALeader && !isBLeader)) sinyalKe3 = "5 Hari";
            }

            let sinyalKe4 = (anggotaLevels[1] > 0) ? "10 Hari" : "Belum Aktif";

            document.getElementById('kpiTotalBonus').textContent = `+${totalBonus.toLocaleString('id-ID')} USDT`;
            document.getElementById('kpiStatus').innerHTML = `<span class="${statusColor} font-bold">${status}</span>`;
            document.getElementById('kpiBonusPeringkat').textContent = cumulativeBonusPeringkat > 0 ? `+${cumulativeBonusPeringkat}` : '';
            document.getElementById('resBonusVolume').textContent = bonusVolume;
            document.getElementById('resModalAwalPanel').textContent = `${saldoAkun.toLocaleString('id-ID')} USDT`;
            document.getElementById('resBatasanModal').textContent = `${batasanModal.toLocaleString('id-ID')} USDT`;
            document.getElementById('resTotalAnggotaPanel').textContent = `${totalAnggotaTim.toLocaleString('id-ID')} Anggota`;

            const check = `<svg class="w-3 h-3 text-emerald-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
            const cross = `<svg class="w-3 h-3 text-slate-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

            const sinyalSSM = `<div class="flex items-center text-xs ${sinyalKe3 !== 'Tidak Aktif' ? 'text-emerald-400' : 'text-slate-400'}">${check} Sinyal Siang & Malam</div>`;
            const sinyal3HTML = `<div class="flex items-center text-xs ${sinyalKe3 !== 'Tidak Aktif' ? 'text-emerald-400' : 'text-slate-500'}">${sinyalKe3 !== 'Tidak Aktif' ? check : cross} Sinyal ke-3: ${sinyalKe3}</div>`;
            const sinyal4HTML = `<div class="flex items-center text-xs ${sinyalKe4 !== 'Belum Aktif' ? 'text-emerald-400' : 'text-slate-500'}">${sinyalKe4 !== 'Belum Aktif' ? check : cross} Sinyal ke-4: ${sinyalKe4}</div>`;
            
            document.getElementById('sinyalContainer').innerHTML = sinyalSSM + sinyal3HTML + sinyal4HTML;

            pulseElement('kpiTotalBonus');
            pulseElement('resModalAwalPanel');

            const isVip9 = (status === "VIP 9"); 
            const juaraMsg = document.getElementById('juara-message-container'); 
            const fokusMsg = document.getElementById('fokus-message'); 
            const championsAudio = document.getElementById('champions-audio');
            
            if (isVip9) { 
                startConfetti(); 
                juaraMsg.classList.remove('hidden'); 
                fokusMsg.classList.add('hidden'); 
                if (championsAudio && championsAudio.paused) {
                    championsAudio.currentTime = 0; championsAudio.loop = true; championsAudio.play().catch(()=>{});
                }
            } else { 
                stopConfetti(); 
                juaraMsg.classList.add('hidden'); 
                fokusMsg.classList.remove('hidden'); 
                if (championsAudio && !championsAudio.paused) {
                    championsAudio.pause(); championsAudio.currentTime = 0;
                }
            }

            const andaLbl = document.getElementById('anda-label'); 
            const ktLbl = document.getElementById('ketua-tim-label'); 
            const crownIcn = document.getElementById('crown-icon'); 
            
            if (anggotaLevels[0] >= 5) { 
                andaLbl.className = "bg-amber-500/20 text-amber-300 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/30";
                ktLbl.innerHTML = `<span class="text-[10px] font-bold text-emerald-400">Ketua Tim</span>`; 
                crownIcn.classList.remove('hidden'); 
            } else { 
                andaLbl.className = "bg-blue-500/20 text-blue-300 text-[10px] font-bold px-2 py-1 rounded border border-blue-500/30";
                ktLbl.innerHTML = ''; 
                crownIcn.classList.add('hidden'); 
            } 
        }

        function pulseElement(id) { const el = document.getElementById(id); if (el) { el.classList.remove('number-pulse'); void el.offsetWidth; el.classList.add('number-pulse'); } }

        function startConfetti() { if (confettiInterval || !confettiCanvas) return; confettiCanvas.style.display = 'block'; confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; confettiInterval = setInterval(() => { for (let i = 0; i < 20; i++) createConfetti(); }, 500); animateConfetti(); }
        function stopConfetti() { if (!confettiInterval) return; clearInterval(confettiInterval); confettiInterval = null; cancelAnimationFrame(animationFrameId); animationFrameId = null; setTimeout(() => { if (confettiCanvas && confettiCtx) { confettiCanvas.style.display = 'none'; confettiPieces = []; confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height); } }, 2000); }
        function createConfetti() { if(confettiCanvas) confettiPieces.push({ x: Math.random() * confettiCanvas.width, y: -20, w: 5 + Math.random() * 10, h: 10 + Math.random() * 10, color: confettiColors[Math.floor(Math.random() * confettiColors.length)], rotation: Math.random() * 360, speedX: Math.random() * 4 - 2, speedY: 2 + Math.random() * 3, opacity: 1 }); }
        function animateConfetti() { if (!confettiCtx || !confettiCanvas) return; animationFrameId = requestAnimationFrame(animateConfetti); confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height); confettiPieces.forEach((piece, index) => { piece.y += piece.speedY; piece.x += piece.speedX; piece.rotation += piece.speedX; piece.opacity -= 0.005; if (piece.y > confettiCanvas.height || piece.opacity <= 0) confettiPieces.splice(index, 1); else { confettiCtx.save(); confettiCtx.translate(piece.x, piece.y); confettiCtx.rotate(piece.rotation * Math.PI / 180); confettiCtx.globalAlpha = piece.opacity; confettiCtx.fillStyle = piece.color; confettiCtx.fillRect(-piece.w / 2, -piece.h / 2, piece.w, piece.h); confettiCtx.restore(); } }); }

        document.addEventListener('DOMContentLoaded', () => {
            const enterButton = document.getElementById('enter-button');
            const splashScreen = document.getElementById('splash-screen');
            const dashboardContent = document.getElementById('dashboard-content');
            
            if (enterButton) {
                enterButton.addEventListener('click', () => {
                    splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                        dashboardContent.style.display = 'block';
                        setTimeout(() => { dashboardContent.style.opacity = '1'; }, 50);
                        if (typeof initializeSimulator === 'function') initializeSimulator();
                    }, 500);
                });
            }
            
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('/BenefitPlan/sw.js').catch(()=>{});

            const audioBtn = document.getElementById('play-audio-button');
            const mainAudio = document.getElementById('tutorial-audio');
            const spkOn = document.getElementById('speaker-icon');
            const spkOff = document.getElementById('speaker-off-icon');

            if(audioBtn && mainAudio) {
                audioBtn.addEventListener('click', () => {
                    const champAudio = document.getElementById('champions-audio');
                    if (champAudio && !champAudio.paused) { champAudio.pause(); champAudio.currentTime = 0; }
                    
                    if (mainAudio.paused) mainAudio.play().catch(()=>{});
                    else mainAudio.pause();
                });
                mainAudio.onplay = () => { spkOn.classList.add('hidden'); spkOff.classList.remove('hidden'); };
                mainAudio.onpause = () => { spkOn.classList.remove('hidden'); spkOff.classList.add('hidden'); };
            }
        });
    </script>
</body>
</html>
